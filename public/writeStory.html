<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Passport Authentication</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/lumen/bootstrap.min.css"
    />
    <link href="css/style.css" rel="stylesheet" />

    <script src="//cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="//cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>

    <link href="//cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
    <link href="//cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet" />
    <style>
      div#displayStory {
    padding-left: 30px;
}
    </style>
  </head>

  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="/logout">
            Logout
          </a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">


        <div class="col-md-6 col-md-offset-3">
          <h1>Welcome <span class="member-name"></span></h1>
          <!-- <h4>Your Age is: <span class="member-age"></span></h4> -->
        </div>
      </div>
        <div class="col-md-6 col-md-offset-3">
          <h2>Wriete Story</h2>
          <div id="toolbar"></div>
          <div id="editor"></div>
        </div>
        <button id="savetext">Submite </button>
        <button id="updateText">Save </button>
      </div>
      <div id="displayStory">
       
      </div>

    </div>
    <form
    class="mt-4"
    action="/api/writeStory/upload"
    method="POST"
    enctype="multipart/form-data"
  >
      <input
        type="file"
        name="file2"
        id="input-files"
        class="form-control-file border"
      />
    
  </form>
  <button type="submit" class="btn btn-primary">Submit</button>
  <!-- <div class >
    <img src= imageURL alt="profile picture" width="500" height="600">
  </div> -->
  <img id="img" width=100%>
    <script>
      var toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        [{ indent: '-1' }, { indent: '+1' }],
        [{ color: [] }, { background: [] }],
      ];

      var quill = new Quill('#editor', {
        modules: {
          toolbar: toolbarOptions,
        },

        theme: 'snow',
      });
      //------------------------------------------------------------------------------------
      // When the signup button is clicked, we validate the email and password are not blank

     
      $.get('/api/user_data').then(data => {

        $('.member-name').text(data.anonymousName);
       $('.member-age').text(data.age);


         var userUuid= data.UserUuid
         displayStory(userUuid);
     
      $('#savetext').click(event => {
   
     var content = document.querySelector('.ql-editor').innerHTML;
   

event.preventDefault();
const storyData = {
  story: content,
};

submitStory(storyData.story, userUuid, data.anonymousName);
       
      });
    });

      // Does a post to the signup route. If successful, we are redirected to the members page
      // Otherwise we log any errors
      function submitStory(story, userUuid,anonymousName) {
        console.log("ready to post------------------>", userUuid, story,anonymousName );
        // debugger;


        $.post(`/api/writeStory`, {
          story: story,
          userUuid:userUuid,
          anonymousName:anonymousName

        })
          .then((display) => {
            // debugger;
            window.location.replace('/writeStory');

            // location.reload();
            //  document.querySelector('.ql-editor').innerHTML = ""
          })
          .catch(handleLoginErr);
      }



function displayStory(userUuid){


  $.get(`/api/writeStory/${userUuid}`).then(data => {

$.each( data, function( key, value ) {

  var editBtn= $(`<button class="edit" data-edit='${value.id}'>Edit</button>`);
 var delBtn =$(`<button class="delete" data-delete='${value.id}'>Delete</button>`);
 var pubBtn =$(`<button class="publish" data-publish='${value.id}'>Publish</button>`);

    $( '<div class="storyList" style="border: 3px solid; padding: 20px; width: 50%; margin-top: 20px;">' ).appendTo( "#displayStory" ).append(value.story).append(editBtn).append(delBtn).append(pubBtn);

});

      });
}



$(document).on('click', '.delete',function (e){
  e.preventDefault();

    var id = $(this).data("delete");
    

    // Send the DELETE request.
    $.ajax("/api/writeStory/delete/" + id, {
      type: "DELETE"
    }).then(
      function() {
        // Reload the page to get the updated list
        location.reload();
      }
    );
  });


  $(document).on('click', '.edit',function (e){
   e.preventDefault();
   var id = $(this).data("edit");
   console.log(id);
   var htmldata;
   $.get(`/api/writeStory/show/`+id).then(data => {

    htmldata= data[0].story;

    // console.log(typeof htmldata);
    
    document.querySelector('.ql-editor').innerHTML= htmldata;

    editing(id);
 
     });

  });




  function editing(id){
    $(document).on('click', '#updateText',function (e){
   e.preventDefault();

var content2 = document.querySelector('.ql-editor').innerHTML;

  $.post(`/api/writeStory/show/${id}`, {
          story: content2,
        })
          .then((display) => {
            // debugger;
            window.location.replace('/writeStory');
           
          })

        });
  }


      function handleLoginErr(err) {
        console.log('Error......');
      }

      //images 
      $(document).ready(function() {
        let imagesPreview = function(input, placeToInsertImagePreview) {
          if (input.files) {
            let filesAmount = input.files.length;
            for (i = 0; i < filesAmount; i++) {
              let reader = new FileReader();
              reader.onload = function(event) {
                $($.parseHTML("<img>"))
                  .attr("src", event.target.result)
                  .appendTo(placeToInsertImagePreview);
              };  
              reader.readAsDataURL(input.files[i]);
            }
          }
        };
        $("#input-files").on("change", function() {
          imagesPreview(this, "div.preview-images");
//          $.ajax("/api/admin/all_user/9c6005e0-0f49-11eb-a858-b32b624976da", {
//       type: "GET"
//     }).then((data)=>{
//       console.log("data :   ", data)
//       var reader = new FileReader();
//     reader.readAsDataURL(data.image); 
//     reader.onloadend = function() {
//     base64data = reader.data; 
//     console.log("+++++++++++++++++++++++=" , base64data)    

    } 
    );

    jQuery.ajax({
  url:'/api/admin/all_user/9c6005e0-0f49-11eb-a858-b32b624976da',
        cache:false,
        xhr:function(){// Seems like the only way to get access to the xhr object
            var xhr = new XMLHttpRequest();
            xhr.responseType= 'blob'
            // return xhr;
            console.log(xhr)
        },
        success: function(data){
            console.log(data, "++++++++++++++++++++++")
            var img = document.getElementById('img');
            console.log(img , "---------------------------")
            var url = window.URL || window.webkitURL;
            console.log(url, " @@@@@@@@@@@@@@@@@@@@@@@@@@@")
            img.src = url.createObjectURL(data);
        },
        error:function(){
          console.log("NOOOOOO")
        }
    });
  });
        
      
        // let blob = await fetch(url).then(r => r.blob());



  
    </script>
  </body>
</html>
